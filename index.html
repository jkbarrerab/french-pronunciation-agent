<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Pronunciation Trainer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>French Pronunciation Trainer</h1>
        <input type="text" id="phrase" placeholder="Enter a French phrase">
        <div class="buttons">
            <button onclick="startRecording()">üéô Start Recording</button>
            <button onclick="stopRecording()">‚èπ Stop & Upload</button>
            <button onclick="playPhrase()">üîä Play Phrase</button>
        </div>
        <p id="result"></p>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.start();
                console.log("Recording started...");
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    console.log("Recording stopped...");
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const wavBlob = await convertToWav(audioBlob);
                    console.log("Converted WAV Blob:", wavBlob);

                    const formData = new FormData();
                    formData.append("audio", wavBlob, "recording.wav");
                    formData.append("reference_text", document.getElementById("phrase").value);

                    console.log("Sending WAV file to backend...");
                    const response = await fetch("https://french-pronunciation-agent.onrender.com/check_pronunciation", {
                        method: "POST",
                        body: formData
                    });

                    const data = await response.json();
                    console.log("Response from server:", data);
                    document.getElementById("result").innerText = `Expected: ${data.expected}\nRecognized: ${data.recognized}\nSimilarity: ${data.similarity}%`;
                };
            }).catch(error => console.error("Microphone access error:", error));
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
        }

        function playPhrase() {
            const phrase = document.getElementById("phrase").value;
            if (!phrase) {
                alert("Please enter a phrase!");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(phrase);
            utterance.lang = "fr-FR"; // Set language to French
            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
